name: TiTO v2
version: 0.0.15
inputs:
  inmapsapikey:
    type: string
    description: google maps api key
    default: AIzaSyA5ZDRG9r8hBWrtlGsEuJKU2KBg_cCV_Qk
  inqty:
    type: integer
    minimum: 1
    maximum: 3
    default: 1
    title: Quantity
    description: How many VMs?
resources:
  Cloud_NSX_LoadBalancer:
    type: Cloud.NSX.LoadBalancer
    metadata:
      layoutPosition:
      - 0
      - 0
    properties:
      name: TITOLoadBalancer
      routes:
      - protocol: HTTP
        port: '80'
      network: ${resource.Web_NSX_Network.name}
      instances: ${resource.FrontEnd.id}
  FrontEnd:
    type: Cloud.Machine
    dependsOn:
    - MySQL
    metadata:
      layoutPosition:
      - 0
      - 1
    properties:
      count: ${input.inqty}
      image: Ubuntu16c
      flavor: 1vCPU-2GB
      storage:
        constraints:
        - tag: vik.stor:raid1
      cloudConfig: "#cloud-config\n# log all cloud-init process output (info & errors)\
        \ to a logfile\noutput: {all: \">> /var/log/cloud-init-output.log\"}\npackages:\n\
        \ - git\nruncmd:\n - echo $(date) ' hello world!' >> /home/vmadmin/hello.txt\n\
        \ - sudo apt install apache2 --assume-yes\n - sudo git clone https://github.com/riazvm/samplecreds.git\n\
        \ - sudo DEBIAN_FRONTEND=noninteractive apt-get install -y python-pip python-dev\
        \ --assume-yes\n - sudo apt install git php libapache2-mod-php php-mysql php-curl\
        \ --assume-yes\n - su - ubuntu\n - eval \"$(ssh-agent -s)\"\n - sudo cd /home/ubuntu/.ssh/\n\
        \ - sudo cp /samplecreds/gitcreds/id_rsa /home/ubuntu/.ssh/.\n - sudo chmod\
        \ 400 /home/ubuntu/.ssh/id_rsa\n - eval \"$(ssh-agent -s)\"\n - ssh-add -k\
        \ /home/ubuntu/.ssh/id_rsa\n - ssh -o StrictHostKeyChecking=no -T git@github.com\n\
        \ - git clone git@github.com:riazm-vmware/OperationSaaS.git\n - cd /var/www/html\n\
        \ - sudo cp -r /OperationSaaS/Tito .\n - sudo chmod +x Tito/asset/Deployment/CloudAssembly/apache/*\n\
        \ - sudo cp Tito/asset/Deployment/CloudAssembly/apache/dir.conf /etc/apache2/mods-enabled/dir.conf\n\
        \ - sudo printf '\\n export TITODBSERVER=${resource.MySQL.networks[0].address}'\
        \ >> Tito/asset/Deployment/CloudAssembly/apache/envvars\n - sudo printf '\\\
        n export TITODBUSERNAME=Tito' >> Tito/asset/Deployment/CloudAssembly/apache/envvars\n\
        \ - sudo printf '\\n export TITODBPASSWORD=VMware1!' >> Tito/asset/Deployment/CloudAssembly/apache/envvars\n\
        \ - sudo printf '\\n export MAPSKEY=${input.inmapsapikey}' >> Tito/asset/Deployment/CloudAssembly/apache/envvars\
        \ \n - sudo cp Tito/asset/Deployment/CloudAssembly/apache/envvars /etc/apache2/envvars\n\
        \ - echo ${resource.MySQL.id}\n - echo ${resource.MySQL.networks[0].address}\n\
        \ - sudo systemctl restart apache2\n"
      name: FE
      networks:
      - name: ${resource.Web_NSX_Network.name}
        network: ${resource.Web_NSX_Network.id}
      assignment: static
  MySQL:
    type: Cloud.Machine
    metadata:
      layoutPosition:
      - 0
      - 2
    properties:
      image: Ubuntu16c
      flavor: 1vCPU-2GB
      tags:
      - key: tito
        value: tito
      - key: environment
        value: dev
      storage:
        constraints:
        - tag: vik.stor:raid1
      cloudConfig: '#cloud-config

        # log all cloud-init process output (info & errors) to a logfile

        output: {all: ">> /var/log/cloud-init-output.log"}

        runcmd:

        - echo $(date) '' hello world!'' >> /home/vmadmin/hello.txt

        - sudo apt-get update

        - sudo git clone https://github.com/riazvm/samplecreds.git

        - sudo DEBIAN_FRONTEND=noninteractive apt-get install -y python-pip python-dev
        --assume-yes

        - echo "mysql-server mysql-server/root_password password Tito2016" | sudo
        debconf-set-selections

        - echo "mysql-server mysql-server/root_password_again password Tito2016" |
        sudo debconf-set-selections

        - sudo apt-get -y install mysql-server

        - sudo apt-get install git unzip --assume-yes

        - su - ubuntu

        - eval "$(ssh-agent -s)"

        - sudo cp /samplecreds/gitcreds/id_rsa /home/ubuntu/.ssh/.

        - sudo chmod 400 /home/ubuntu/.ssh/id_rsa

        - eval "$(ssh-agent -s)"

        - ssh-add -k /home/ubuntu/.ssh/id_rsa

        - sudo cd /home/ubuntu/.ssh/

        - ssh -o StrictHostKeyChecking=no -T git@github.com

        - git clone git@github.com:riazm-vmware/OperationSaaS.git

        - sudo cp -r /OperationSaaS/Tito /.

        - sudo cp /Tito/asset/Deployment/CloudAssembly/titodb/mysqld.cnf /etc/mysql/mysql.conf.d/mysqld.cnf

        - sudo systemctl restart mysql.service

        - cd /Tito/asset/Deployment/CloudAssembly/titodb/

        - sudo chmod 777 *

        - sudo chmod +x *

        - export MYSQL_ROOT_PASSWORD=Tito2016

        - sudo mysql --user=root --password=$MYSQL_ROOT_PASSWORD < create-tito-db.sql

        '
      networks:
      - name: ${resource.Database_NSX_Network.name}
        network: ${resource.Database_NSX_Network.id}
      assignment: static
      name: DB
  Web_NSX_Network:
    type: Cloud.NSX.Network
    metadata:
      layoutPosition:
      - 1
      - 0
    properties:
      name: WebNetwork
      networkType: existing
      constraints:
      - tag: vik.net:web
  Database_NSX_Network:
    type: Cloud.NSX.Network
    metadata:
      layoutPosition:
      - 2
      - 0
    properties:
      name: DatabaseNetwork
      networkType: existing
      constraints:
      - tag: vik.net:data
